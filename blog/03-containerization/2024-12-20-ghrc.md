---
title: "Registry : GitHub GHCR"
tags: [containerization, devops]
---

GitHub Container Registry (GHCR) est un service d'h√©bergement de packages logiciels propos√© par GitHub, permettant aux utilisateurs de stocker des packages priv√©s ou publics et de les utiliser comme d√©pendances dans leurs projets. Compatible avec plusieurs langages de programmation, GitHub Packages propose des registres pour des gestionnaires de packages tels que npm, RubyGems, Maven, Gradle, Docker, et NuGet. L'authentification sur GitHub Packages se fait exclusivement via un "personal access token (classic)". Les utilisateurs doivent disposer de ce token pour effectuer des op√©rations telles que la publication, l'installation et la suppression de packages, qu'ils soient publics, priv√©s ou internes. Pour les packages priv√©s, GitHub Packages applique des limites de stockage et de transfert de donn√©es en fonction du plan du compte. La gestion des packages peut √™tre r√©alis√©e √† travers l'interface utilisateur GitHub ou via l'API REST. Des webhooks peuvent √©galement √™tre configur√©s pour suivre des √©v√©nements li√©s aux packages, comme la publication ou la mise √† jour.

<!--truncate-->

## Qu'est-ce que GitHub GHCR?

GitHub Container Registry (GHCR) est un service d'h√©bergement de conteneurs Docker propos√© par GitHub. Il permet aux utilisateurs de stocker, g√©rer et distribuer des images Docker en toute s√©curit√©. GHCR est int√©gr√© √† GitHub, ce qui facilite l'utilisation des conteneurs dans les workflows de d√©veloppement et de d√©ploiement.

## Pourquoi utiliser GitHub GHCR?

L'utilisation de GitHub GHCR pr√©sente plusieurs avantages :

1. **S√©curit√©** : GHCR offre des fonctionnalit√©s de s√©curit√© avanc√©es, telles que l'authentification et l'autorisation bas√©es sur les tokens d'acc√®s personnels (PAT). Les images peuvent √™tre priv√©es ou publiques, et les utilisateurs peuvent contr√¥ler l'acc√®s aux images en fonction de leurs besoins.

2. **Int√©gration avec GitHub** : GHCR est √©troitement int√©gr√© √† GitHub, ce qui permet aux utilisateurs de g√©rer leurs images Docker directement depuis leurs d√©p√¥ts GitHub. Les workflows GitHub Actions peuvent √™tre utilis√©s pour automatiser la cr√©ation, le test et le d√©ploiement des images Docker.

3. **Gestion des versions** : GHCR prend en charge la gestion des versions des images Docker, ce qui permet aux utilisateurs de suivre les modifications apport√©es aux images et de revenir √† des versions ant√©rieures si n√©cessaire.

4. **Suivi des √©v√©nements** : GHCR permet de configurer des webhooks pour suivre les √©v√©nements li√©s aux images Docker, tels que la publication, la mise √† jour et la suppression. Cela permet aux utilisateurs de rester inform√©s des modifications apport√©es aux images et de r√©agir en cons√©quence.

## Exemple de workflow pour utiliser GitHub GHCR

Le workflow suppose que vous avez un `Dockerfile` √† la racine du d√©p√¥t. Ce `Dockerfile` doit r√©ussir la commande de `build` avec succ√®s

### Cr√©ez un fichier YAML pour le Workflow

Cr√©ez un fichier YAML (par exemple, `docker-publish.yml`) dans le r√©pertoire `.github/workflows/` de votre d√©p√¥t avec le contenu suivant :

```yaml
name: Create and publish a Docker image

on:
    push:
    branches: ['release']

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}

jobs:
    build-and-push-image:
    runs-on: ubuntu-latest

    permissions:
        contents: read
        packages: write

    steps:
        - name: Checkout repository
        uses: actions/checkout@v4

        - name: Log in to the Container registry
        uses: docker/login-action@65b78e6e13532edd9afa3aa52ac7964289d1a9c1
        with:
            registry: ${{ env.REGISTRY }}
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}

        - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@9ec57ed1fcdbf14dcef7dfbe97b2010124a938b7
        with:
            images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

        - name: Build and push Docker image
        uses: docker/build-push-action@f2a1d5e99d037542a71f64918e516c093c6f3fc4
        with:
            context: .
            push: true
            tags: ${{ steps.meta.outputs.tags }}
            labels: ${{ steps.meta.outputs.labels }}
```

### Configurez les Options du Workflow

Dans le fichier YAML, vous pouvez personnaliser les options suivantes selon vos besoins :

- `branches`: Modifiez la branche d√©clenchant le workflow.
- `REGISTRY` et `IMAGE_NAME`: Modifiez-les si vous souhaitez utiliser un autre registre ou nom d'image.
- `permissions`: Ajustez les autorisations en fonction de vos besoins.

**Enregistrez et Poussez vos Modifications**
Enregistrez les modifications dans le fichier YAML et poussez-les vers la branche "release" de votre d√©p√¥t GitHub.

```shell
git add .github/workflows/docker-publish.yml
git commit -m "Ajout du workflow de publication Docker"
git push origin release
```

### Utilisation d‚Äôun package GHCR

Une fois d√©ploy√©, le package s‚Äôutilise comme n‚Äôimporte quel docker

```shell
docker pull ghcr.io/{USER}/{REPO-NAME}:master
```

üí° L‚Äôutilisation des Github GHCR entraine des consommations d‚Äôespace. Le CATIE a le droit √† 2Gb de stockage sur GHCR et 10Gb de transit par mois. Au del√† de ces limites, nous sommes factur√©s.
L‚Äôutilisation (sous n‚Äôimporte quelle forme) de GHCR sur des d√©p√¥ts **publics** est totalement gratuite Sur des d√©p√¥ts priv√©s : le pull via des actions est gratuit. Pour les actions `self-hosted` le pull est gratuit si l‚Äôaction est authentifi√©e par le `GITHUB_TOKEN` et non un PAT.

Voici un exemple d‚Äôutilisation sans co√ªt associ√©

```yaml
name: Run in container from GHCR

on: [ push ]

jobs:
    myJob:
    runs-on: ubuntu-latest
    container:
        image: ghcr.io/sedelpeuch/github-ghcr-test:master
    steps:

        - name: Checkout code
        uses: actions/checkout@v2

        - name: Run a command
        run: echo "Running inside the container"
```

L‚Äôimage [ghcr.io/sedelpeuch/github-ghcr-test:master](<http://ghcr.io/sedelpeuch/github-ghcr-test:master>) est priv√©e, l‚Äôacc√®s est possible sans donner de PAT gr√¢ce √† l‚Äôauthentification par jeton automatique qui poss√®de la lecture des packages priv√©s [https://docs.github.com/fr/actions/security-guides/automatic-token-authentication#permissions-for-the-github_token](https://docs.github.com/fr/actions/security-guides/automatic-token-authentication#permissions-for-the-github_token)
