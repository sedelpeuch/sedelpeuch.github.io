name: GitHub Pages

on:
  push:
    branches:
      - master
  schedule:
    # 18:00 lundi-vendredi (pour attraper les pushes des heures de travail)
    - cron: "0 18 * * 1-5"
  workflow_dispatch:

permissions:
  id-token: write
  contents: write
  pages: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-schedule:
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
    steps:
      - name: Check if outside work hours
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date();
            const day = now.getDay();     // 0 = dimanche, 6 = samedi
            const hour = now.getHours();

            // Est en dehors des heures de travail si:
            // - C'est le weekend (samedi=6 ou dimanche=0)
            // - OU c'est un jour de semaine (1-5) mais après 18h ou avant 8h
            const isWeekend = day === 0 || day === 6;
            const isOutsideWorkHours = hour >= 18 || hour < 8;

            // Pour un push, on déploie si c'est en dehors des heures de travail
            if (context.eventName === 'push') {
              const shouldDeploy = isWeekend || isOutsideWorkHours;
              console.log(`PUSH - shouldDeploy = ${shouldDeploy}`);
              core.setOutput('should-deploy', shouldDeploy ? 'true' : 'false');
              console.log(`OUTPUT SET TO: ${shouldDeploy ? 'true' : 'false'}`);
              if (!shouldDeploy) {
                core.notice(`⏸️ Déploiement en attente. Exécution prévue à 18:00 aujourd'hui.`);
              } else {
                core.notice(`✅ Déploiement immédiat (en dehors des heures de travail)`);
              }
              return;
            }

            // Pour un schedule, on ne déploie que s'il y a eu un push récent (dernières 24h)
            if (context.eventName === 'schedule') {
              const since = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
              const { data: commits } = await github.rest.repos.listCommits({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: 'master',
                since: since,
                per_page: 1
              });

              if (commits.length === 0) {
                console.log(`SCHEDULE - No commits in last 24h`);
                core.setOutput('should-deploy', 'false');
                console.log(`OUTPUT SET TO: false`);
                core.notice('⏸️ Aucun commit dans les dernières 24h, déploiement annulé');
                return;
              }

              console.log(`SCHEDULE - Recent commit found, deploying`);
              core.setOutput('should-deploy', 'true');
              console.log(`OUTPUT SET TO: true`);
              core.notice(`✅ Commit récent détecté, déploiement`);
              return;
            }

            // Pour workflow_dispatch, toujours déployer
            console.log(`WORKFLOW_DISPATCH - Always deploy`);
            core.setOutput('should-deploy', 'true');
            console.log(`OUTPUT SET TO: true`);
            core.notice(`✅ Déploiement manuel`);

  deploy:
    needs: check-schedule
    if: needs.check-schedule.outputs.should-deploy == 'true'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    container:
      image: node:20
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Install dependencies
        run: |
          yarn install --frozen-lockfile --non-interactive
          apt update && apt install -y rsync
      - name: Build
        run: yarn build
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: build
          clean-exclude: pr-preview/
          force: false
          git-config-email: actions@github.com
          git-config-name: GitHub Actions
