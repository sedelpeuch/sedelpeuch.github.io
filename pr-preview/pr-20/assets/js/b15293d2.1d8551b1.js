"use strict";(self.webpackChunksedelpeuch_net=self.webpackChunksedelpeuch_net||[]).push([[9899],{23(e,n,s){s.r(n),s.d(n,{assets:()=>t,contentTitle:()=>a,default:()=>u,frontMatter:()=>o,metadata:()=>r,toc:()=>c});var r=s(91362),l=s(74848),i=s(28453);const o={title:"Loki",description:"Loki, le syst\xe8me de gestion de logs inspir\xe9 de Prometheus, con\xe7u pour \xeatre simple, efficace et \xe9conomique.",tags:["monitoring","devops"]},a=void 0,t={authorsImageUrls:[]},c=[{value:"Qu&#39;est-ce que Loki ? \ud83e\udd14",id:"quest-ce-que-loki--",level:2},{value:"Pourquoi Loki ? \ud83c\udfaf",id:"pourquoi-loki--",level:3},{value:"Architecture de Loki \ud83c\udfd7\ufe0f",id:"architecture-de-loki-\ufe0f",level:2},{value:"Composants principaux",id:"composants-principaux",level:3},{value:"Installation de Loki \ud83d\ude80",id:"installation-de-loki-",level:2},{value:"Installation avec Docker Compose",id:"installation-avec-docker-compose",level:3},{value:"Installation sur Kubernetes avec Helm",id:"installation-sur-kubernetes-avec-helm",level:3},{value:"Installation distribu\xe9e sur Kubernetes",id:"installation-distribu\xe9e-sur-kubernetes",level:3},{value:"Configuration de Promtail \ud83d\udccb",id:"configuration-de-promtail-",level:2},{value:"Configuration de base",id:"configuration-de-base",level:3},{value:"Configuration avanc\xe9e avec pipeline",id:"configuration-avanc\xe9e-avec-pipeline",level:3},{value:"Configuration pour Kubernetes",id:"configuration-pour-kubernetes",level:3},{value:"Introduction \xe0 LogQL \ud83d\udd0d",id:"introduction-\xe0-logql-",level:2},{value:"S\xe9lecteurs de flux de logs",id:"s\xe9lecteurs-de-flux-de-logs",level:3},{value:"Filtres de lignes",id:"filtres-de-lignes",level:3},{value:"Parsers",id:"parsers",level:3},{value:"Filtres de labels extraits",id:"filtres-de-labels-extraits",level:3},{value:"Agr\xe9gations et fonctions",id:"agr\xe9gations-et-fonctions",level:3},{value:"Exemples pratiques",id:"exemples-pratiques",level:3},{value:"Visualisation avec Grafana \ud83d\udcca",id:"visualisation-avec-grafana-",level:2},{value:"Ajouter Loki comme source de donn\xe9es",id:"ajouter-loki-comme-source-de-donn\xe9es",level:3},{value:"Cr\xe9er un dashboard",id:"cr\xe9er-un-dashboard",level:3},{value:"Explorer les logs",id:"explorer-les-logs",level:3},{value:"Int\xe9gration avec Kubernetes \ud83d\udea2",id:"int\xe9gration-avec-kubernetes-",level:2},{value:"Collecter les logs de pods",id:"collecter-les-logs-de-pods",level:3},{value:"Annoter les pods pour enrichir les logs",id:"annoter-les-pods-pour-enrichir-les-logs",level:3},{value:"Requ\xeates LogQL pour Kubernetes",id:"requ\xeates-logql-pour-kubernetes",level:3},{value:"Bonnes pratiques \ud83d\udc4d",id:"bonnes-pratiques-",level:2},{value:"1. Utiliser des labels efficacement",id:"1-utiliser-des-labels-efficacement",level:3},{value:"2. Structurer les logs en JSON",id:"2-structurer-les-logs-en-json",level:3},{value:"3. Optimiser les requ\xeates LogQL",id:"3-optimiser-les-requ\xeates-logql",level:3},{value:"4. Configurer la r\xe9tention des logs",id:"4-configurer-la-r\xe9tention-des-logs",level:3},{value:"5. Utiliser le multi-tenancy",id:"5-utiliser-le-multi-tenancy",level:3},{value:"Cas d&#39;usage avanc\xe9s \ud83d\ude80",id:"cas-dusage-avanc\xe9s-",level:2},{value:"Alerting avec Loki et Prometheus",id:"alerting-avec-loki-et-prometheus",level:3},{value:"Tracer les requ\xeates entre services",id:"tracer-les-requ\xeates-entre-services",level:3},{value:"D\xe9tecter les anomalies",id:"d\xe9tecter-les-anomalies",level:3},{value:"Conclusion \ud83c\udfaf",id:"conclusion-",level:2},{value:"Ressources utiles \ud83d\udcda",id:"ressources-utiles-",level:2}];function d(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.p,{children:"Loki est un syst\xe8me d'agr\xe9gation de logs horizontalement scalable, hautement disponible et multi-tenant, inspir\xe9 par Prometheus. Cr\xe9\xe9 par Grafana Labs, Loki se distingue par son approche minimaliste : plut\xf4t que d'indexer le contenu des logs, il n'indexe que les m\xe9tadonn\xe9es (labels), ce qui le rend extr\xeamement efficace et \xe9conomique. \ud83d\udcdd"}),"\n",(0,l.jsx)(n.h2,{id:"quest-ce-que-loki--",children:"Qu'est-ce que Loki ? \ud83e\udd14"}),"\n",(0,l.jsx)(n.p,{children:'Loki est souvent d\xe9crit comme "Prometheus, mais pour les logs". Il partage plusieurs concepts avec Prometheus :'}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Mod\xe8le de donn\xe9es bas\xe9 sur les labels"})," : identification des flux de logs par des labels"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Langage de requ\xeate puissant"})," : LogQL, inspir\xe9 de PromQL"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Int\xe9gration native avec Grafana"})," : visualisation unifi\xe9e des m\xe9triques et logs"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Architecture cloud-native"})," : con\xe7u pour Kubernetes et les microservices"]}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"pourquoi-loki--",children:"Pourquoi Loki ? \ud83c\udfaf"}),"\n",(0,l.jsx)(n.p,{children:"Les syst\xe8mes de logs traditionnels (ELK, Splunk) indexent tout le contenu des logs, ce qui :"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Co\xfbte cher"})," en stockage et en ressources de calcul"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Est lent"})," \xe0 l'ingestion pour de gros volumes"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"N\xe9cessite"})," une infrastructure complexe"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Loki adopte une approche diff\xe9rente :"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"N'indexe que les m\xe9tadonn\xe9es"})," (labels), pas le contenu"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Stocke les logs compress\xe9s"})," de mani\xe8re s\xe9quentielle"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Utilise le stockage objet"})," (S3, GCS, etc.) pour r\xe9duire les co\xfbts"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Requ\xeates rapides"})," gr\xe2ce aux labels index\xe9s"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"architecture-de-loki-\ufe0f",children:"Architecture de Loki \ud83c\udfd7\ufe0f"}),"\n",(0,l.jsx)(n.p,{children:"L'architecture de Loki se compose de plusieurs composants :"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                         Applications                         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                     \u2502\n                     \u25bc\n              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n              \u2502  Promtail   \u2502  (Agent de collecte)\n              \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                     \u2502\n                     \u25bc\n         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n         \u2502   Loki Distributor    \u2502  (Point d'entr\xe9e)\n         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                    \u2502\n         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n         \u2502                     \u2502\n         \u25bc                     \u25bc\n    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502 Ingester\u2502          \u2502 Ingester\u2502  (Buffer + \xc9criture)\n    \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518          \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518\n         \u2502                    \u2502\n         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                    \u2502\n                    \u25bc\n            \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n            \u2502   Storage    \u2502  (S3, GCS, Filesystem)\n            \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                   \u2502\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502                     \u2502\n        \u25bc                     \u25bc\n   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n   \u2502 Querier \u2502          \u2502 Querier \u2502  (Lecture)\n   \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518          \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518\n        \u2502                    \u2502\n        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                   \u2502\n                   \u25bc\n            \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n            \u2502  Grafana   \u2502  (Visualisation)\n            \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,l.jsx)(n.h3,{id:"composants-principaux",children:"Composants principaux"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Promtail"})," : Agent qui collecte les logs et les envoie \xe0 Loki"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Distributor"})," : Re\xe7oit les logs et les distribue aux ingesters"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Ingester"})," : Tampon en m\xe9moire qui \xe9crit les logs par batch dans le stockage"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Querier"})," : Traite les requ\xeates LogQL"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Storage"})," : Stockage backend (filesystem, S3, GCS, etc.)"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"installation-de-loki-",children:"Installation de Loki \ud83d\ude80"}),"\n",(0,l.jsx)(n.h3,{id:"installation-avec-docker-compose",children:"Installation avec Docker Compose"}),"\n",(0,l.jsx)(n.p,{children:"La m\xe9thode la plus simple pour tester localement :"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:'# docker-compose.yml\nversion: "3"\n\nservices:\n  loki:\n    image: grafana/loki:2.9.0\n    ports:\n      - "3100:3100"\n    command: -config.file=/etc/loki/local-config.yaml\n    volumes:\n      - ./loki-data:/loki\n\n  promtail:\n    image: grafana/promtail:2.9.0\n    volumes:\n      - /var/log:/var/log\n      - ./promtail-config.yml:/etc/promtail/config.yml\n    command: -config.file=/etc/promtail/config.yml\n\n  grafana:\n    image: grafana/grafana:latest\n    ports:\n      - "3000:3000"\n    environment:\n      - GF_SECURITY_ADMIN_PASSWORD=admin\n    volumes:\n      - grafana-storage:/var/lib/grafana\n\nvolumes:\n  grafana-storage:\n'})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"# D\xe9marrer la stack\ndocker-compose up -d\n"})}),"\n",(0,l.jsx)(n.h3,{id:"installation-sur-kubernetes-avec-helm",children:"Installation sur Kubernetes avec Helm"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"# Ajouter le repo Helm de Grafana\nhelm repo add grafana https://grafana.github.io/helm-charts\nhelm repo update\n\n# Installer Loki (mode simple)\nhelm install loki grafana/loki-stack \\\n  --namespace monitoring \\\n  --create-namespace \\\n  --set grafana.enabled=true \\\n  --set prometheus.enabled=true \\\n  --set promtail.enabled=true\n\n# V\xe9rifier le d\xe9ploiement\nkubectl get pods -n monitoring\n"})}),"\n",(0,l.jsx)(n.h3,{id:"installation-distribu\xe9e-sur-kubernetes",children:"Installation distribu\xe9e sur Kubernetes"}),"\n",(0,l.jsx)(n.p,{children:"Pour la production, utilisez le mode distribu\xe9 :"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:'# Installer Loki en mode distribu\xe9\nhelm install loki grafana/loki-distributed \\\n  --namespace monitoring \\\n  --create-namespace \\\n  --set loki.schemaConfig.configs[0].from="2024-01-01" \\\n  --set loki.schemaConfig.configs[0].store=boltdb-shipper \\\n  --set loki.schemaConfig.configs[0].object_store=s3 \\\n  --set loki.storageConfig.boltdb_shipper.shared_store=s3 \\\n  --set loki.storageConfig.aws.s3=s3://region/bucket\n'})}),"\n",(0,l.jsx)(n.h2,{id:"configuration-de-promtail-",children:"Configuration de Promtail \ud83d\udccb"}),"\n",(0,l.jsx)(n.p,{children:"Promtail est l'agent qui collecte les logs et les envoie \xe0 Loki."}),"\n",(0,l.jsx)(n.h3,{id:"configuration-de-base",children:"Configuration de base"}),"\n",(0,l.jsxs)(n.p,{children:["Cr\xe9ez un fichier ",(0,l.jsx)(n.code,{children:"promtail-config.yml"})," :"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:"server:\n  http_listen_port: 9080\n  grpc_listen_port: 0\n\npositions:\n  filename: /tmp/positions.yaml\n\nclients:\n  - url: http://loki:3100/loki/api/v1/push\n\nscrape_configs:\n  # Collecter les logs syst\xe8me\n  - job_name: system\n    static_configs:\n      - targets:\n          - localhost\n        labels:\n          job: varlogs\n          host: my-server\n          __path__: /var/log/*.log\n\n  # Collecter les logs d'une application\n  - job_name: myapp\n    static_configs:\n      - targets:\n          - localhost\n        labels:\n          job: myapp\n          environment: production\n          __path__: /app/logs/*.log\n"})}),"\n",(0,l.jsx)(n.h3,{id:"configuration-avanc\xe9e-avec-pipeline",children:"Configuration avanc\xe9e avec pipeline"}),"\n",(0,l.jsx)(n.p,{children:"Promtail peut parser et enrichir les logs avant de les envoyer :"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:"scrape_configs:\n  - job_name: nginx\n    static_configs:\n      - targets:\n          - localhost\n        labels:\n          job: nginx\n          __path__: /var/log/nginx/access.log\n\n    pipeline_stages:\n      # Parser le format de log nginx\n      - regex:\n          expression: '^(?P<ip>\\S+) \\S+ \\S+ \\[(?P<time>[^\\]]+)\\] \"(?P<method>\\S+) (?P<path>\\S+) \\S+\" (?P<status>\\d+) (?P<size>\\d+)'\n\n      # Extraire des labels depuis les champs pars\xe9s\n      - labels:\n          method:\n          status:\n          path:\n\n      # Ajouter un timestamp\n      - timestamp:\n          source: time\n          format: '02/Jan/2006:15:04:05 -0700'\n\n      # Filtrer certains logs (optionnel)\n      - match:\n          selector: '{status=\"200\"}'\n          action: drop\n"})}),"\n",(0,l.jsx)(n.h3,{id:"configuration-pour-kubernetes",children:"Configuration pour Kubernetes"}),"\n",(0,l.jsx)(n.p,{children:"Promtail peut automatiquement d\xe9couvrir les pods Kubernetes :"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:"scrape_configs:\n  - job_name: kubernetes-pods\n    kubernetes_sd_configs:\n      - role: pod\n\n    relabel_configs:\n      # Extraire les m\xe9tadonn\xe9es Kubernetes\n      - source_labels:\n          - __meta_kubernetes_pod_node_name\n        target_label: __host__\n\n      - action: labelmap\n        regex: __meta_kubernetes_pod_label_(.+)\n\n      - source_labels:\n          - __meta_kubernetes_namespace\n        target_label: namespace\n\n      - source_labels:\n          - __meta_kubernetes_pod_name\n        target_label: pod\n\n      - source_labels:\n          - __meta_kubernetes_pod_container_name\n        target_label: container\n\n      - replacement: /var/log/pods/*$1/*.log\n        separator: /\n        source_labels:\n          - __meta_kubernetes_pod_uid\n          - __meta_kubernetes_pod_container_name\n        target_label: __path__\n"})}),"\n",(0,l.jsx)(n.h2,{id:"introduction-\xe0-logql-",children:"Introduction \xe0 LogQL \ud83d\udd0d"}),"\n",(0,l.jsx)(n.p,{children:"LogQL est le langage de requ\xeate de Loki, inspir\xe9 de PromQL."}),"\n",(0,l.jsx)(n.h3,{id:"s\xe9lecteurs-de-flux-de-logs",children:"S\xe9lecteurs de flux de logs"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-logql",children:'# S\xe9lectionner par label exact\n{job="nginx"}\n\n# Combiner plusieurs labels\n{job="nginx", environment="production"}\n\n# Op\xe9rateurs de correspondance\n{job=~"nginx|apache"}  # Regex: nginx OU apache\n{status!="200"}        # status diff\xe9rent de 200\n{path=~"/api/.*"}      # path commence par /api/\n'})}),"\n",(0,l.jsx)(n.h3,{id:"filtres-de-lignes",children:"Filtres de lignes"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-logql",children:'# Rechercher une cha\xeene de caract\xe8res\n{job="nginx"} |= "error"\n\n# Exclure une cha\xeene\n{job="nginx"} != "debug"\n\n# Utiliser des regex\n{job="nginx"} |~ "error|ERROR|Error"\n\n# Combiner plusieurs filtres\n{job="nginx"} |= "error" != "timeout"\n'})}),"\n",(0,l.jsx)(n.h3,{id:"parsers",children:"Parsers"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-logql",children:'# Parser JSON\n{job="myapp"} | json\n\n# Parser JSON et extraire des champs\n{job="myapp"} | json | level="error"\n\n# Parser avec regex\n{job="nginx"} | regexp "(?P<method>\\\\w+) (?P<path>\\\\S+)"\n\n# Parser logfmt\n{job="myapp"} | logfmt\n'})}),"\n",(0,l.jsx)(n.h3,{id:"filtres-de-labels-extraits",children:"Filtres de labels extraits"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-logql",children:'# Apr\xe8s parsing, filtrer sur les labels extraits\n{job="myapp"} | json | level="error"\n\n# Utiliser les op\xe9rateurs de comparaison\n{job="nginx"} | json | status >= 400\n\n# Combiner avec des filtres de lignes\n{job="myapp"} | json | level="error" |= "database"\n'})}),"\n",(0,l.jsx)(n.h3,{id:"agr\xe9gations-et-fonctions",children:"Agr\xe9gations et fonctions"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-logql",children:'# Compter le nombre de lignes\ncount_over_time({job="nginx"}[5m])\n\n# Taux de logs par seconde\nrate({job="nginx"}[5m])\n\n# Somme des octets\nsum(rate({job="nginx"} | json | unwrap bytes[5m]))\n\n# Compter par label\nsum by (status) (count_over_time({job="nginx"} | json [5m]))\n\n# Moyenne d\'une valeur num\xe9rique\navg(rate({job="myapp"} | json | unwrap response_time [5m]))\n\n# Quantiles (p95, p99)\nquantile_over_time(0.95, {job="myapp"} | json | unwrap duration [5m])\n'})}),"\n",(0,l.jsx)(n.h3,{id:"exemples-pratiques",children:"Exemples pratiques"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-logql",children:'# Tous les logs d\'erreur des 5 derni\xe8res minutes\n{job="myapp"} |= "error" [5m]\n\n# Taux d\'erreurs HTTP 5xx\nsum(rate({job="nginx"} | json | status >= 500 [5m]))\n\n# Top 5 des chemins les plus appel\xe9s\ntopk(5, sum by (path) (rate({job="nginx"} | json [5m])))\n\n# Logs d\'erreur dans un namespace Kubernetes sp\xe9cifique\n{namespace="production"} |= "error" | json | level="error"\n\n# Dur\xe9e moyenne des requ\xeates API\navg(rate({job="api"} | json | unwrap duration [5m]))\n\n# Logs avec un certain pattern dans les derni\xe8res heures\n{job="myapp"} |~ "database.*timeout" [1h]\n\n# Grouper par niveau de log et compter\nsum by (level) (count_over_time({job="myapp"} | json [5m]))\n\n# D\xe9tecter les pics de logs (anomalies)\ncount_over_time({job="myapp"}[5m]) > 1000\n'})}),"\n",(0,l.jsx)(n.h2,{id:"visualisation-avec-grafana-",children:"Visualisation avec Grafana \ud83d\udcca"}),"\n",(0,l.jsx)(n.h3,{id:"ajouter-loki-comme-source-de-donn\xe9es",children:"Ajouter Loki comme source de donn\xe9es"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:["Ouvrir Grafana : ",(0,l.jsx)(n.code,{children:"http://localhost:3000"})]}),"\n",(0,l.jsxs)(n.li,{children:["Aller dans ",(0,l.jsx)(n.strong,{children:"Configuration > Data Sources"})]}),"\n",(0,l.jsxs)(n.li,{children:["Cliquer sur ",(0,l.jsx)(n.strong,{children:"Add data source"})]}),"\n",(0,l.jsxs)(n.li,{children:["S\xe9lectionner ",(0,l.jsx)(n.strong,{children:"Loki"})]}),"\n",(0,l.jsxs)(n.li,{children:["Configurer l'URL : ",(0,l.jsx)(n.code,{children:"http://loki:3100"})]}),"\n",(0,l.jsxs)(n.li,{children:["Cliquer sur ",(0,l.jsx)(n.strong,{children:"Save & Test"})]}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"cr\xe9er-un-dashboard",children:"Cr\xe9er un dashboard"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-jsonnet",children:'// Exemple de panel Grafana avec LogQL\n{\n  "datasource": "Loki",\n  "targets": [\n    {\n      "expr": "sum by (level) (count_over_time({job=\\"myapp\\"} | json [5m]))",\n      "refId": "A"\n    }\n  ],\n  "title": "Logs par niveau",\n  "type": "timeseries"\n}\n'})}),"\n",(0,l.jsx)(n.h3,{id:"explorer-les-logs",children:"Explorer les logs"}),"\n",(0,l.jsxs)(n.p,{children:["L'onglet ",(0,l.jsx)(n.strong,{children:"Explore"})," de Grafana permet d'explorer les logs interactivement :"]}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:["S\xe9lectionner ",(0,l.jsx)(n.strong,{children:"Loki"})," comme source de donn\xe9es"]}),"\n",(0,l.jsx)(n.li,{children:"Utiliser le builder de requ\xeate ou \xe9crire du LogQL"}),"\n",(0,l.jsx)(n.li,{children:"Visualiser les r\xe9sultats en temps r\xe9el"}),"\n",(0,l.jsx)(n.li,{children:"Filtrer, parser et agr\xe9ger les logs"}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"int\xe9gration-avec-kubernetes-",children:"Int\xe9gration avec Kubernetes \ud83d\udea2"}),"\n",(0,l.jsx)(n.h3,{id:"collecter-les-logs-de-pods",children:"Collecter les logs de pods"}),"\n",(0,l.jsx)(n.p,{children:"Avec Promtail d\xe9ploy\xe9 en DaemonSet, les logs de tous les pods sont automatiquement collect\xe9s."}),"\n",(0,l.jsx)(n.h3,{id:"annoter-les-pods-pour-enrichir-les-logs",children:"Annoter les pods pour enrichir les logs"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:'apiVersion: v1\nkind: Pod\nmetadata:\n  name: myapp\n  labels:\n    app: myapp\n    version: v1.2.3\n  annotations:\n    loki.io/scrape: "true"\n    loki.io/parser: "json"\nspec:\n  containers:\n    - name: myapp\n      image: myapp:1.2.3\n'})}),"\n",(0,l.jsx)(n.h3,{id:"requ\xeates-logql-pour-kubernetes",children:"Requ\xeates LogQL pour Kubernetes"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-logql",children:'# Logs d\'un pod sp\xe9cifique\n{pod="myapp-5d8f7c8b9-abc12"}\n\n# Logs d\'un namespace\n{namespace="production"}\n\n# Logs d\'une application (via label)\n{app="myapp"}\n\n# Logs d\'erreur dans tous les pods d\'une app\n{app="myapp"} |= "error"\n\n# Combiner plusieurs filtres Kubernetes\n{namespace="production", app="api"} | json | level="error"\n'})}),"\n",(0,l.jsx)(n.h2,{id:"bonnes-pratiques-",children:"Bonnes pratiques \ud83d\udc4d"}),"\n",(0,l.jsx)(n.h3,{id:"1-utiliser-des-labels-efficacement",children:"1. Utiliser des labels efficacement"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:'# \u2705 BON : Labels avec cardinalit\xe9 faible\nlabels:\n  environment: production\n  app: myapp\n  level: error\n\n# \u274c MAUVAIS : Labels avec cardinalit\xe9 \xe9lev\xe9e\nlabels:\n  user_id: "123456"      # \xc9viter\n  request_id: "abc-def"  # \xc9viter\n  timestamp: "..."       # \xc9viter\n'})}),"\n",(0,l.jsx)(n.h3,{id:"2-structurer-les-logs-en-json",children:"2. Structurer les logs en JSON"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:'# Python avec structlog\nimport structlog\n\nlog = structlog.get_logger()\nlog.info(\n    "user_login",\n    user_id="12345",\n    ip="192.168.1.1",\n    status="success"\n)\n'})}),"\n",(0,l.jsx)(n.p,{children:"Sortie :"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-json",children:'{"event": "user_login", "user_id": "12345", "ip": "192.168.1.1", "status": "success", "timestamp": "2025-11-15T10:00:00Z"}\n'})}),"\n",(0,l.jsx)(n.h3,{id:"3-optimiser-les-requ\xeates-logql",children:"3. Optimiser les requ\xeates LogQL"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-logql",children:'# \u2705 BON : Filtrer d\'abord avec des labels\n{job="nginx", status="500"}\n\n# \u274c MOINS BON : Filtrer seulement avec le contenu\n{job="nginx"} |= "500"\n\n# \u2705 BON : Utiliser des plages temporelles courtes\n{job="nginx"}[5m]\n\n# \u274c MAUVAIS : Plages temporelles tr\xe8s longues\n{job="nginx"}[24h]\n'})}),"\n",(0,l.jsx)(n.h3,{id:"4-configurer-la-r\xe9tention-des-logs",children:"4. Configurer la r\xe9tention des logs"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:"# loki-config.yaml\nlimits_config:\n  retention_period: 744h  # 31 jours\n\ntable_manager:\n  retention_deletes_enabled: true\n  retention_period: 744h\n"})}),"\n",(0,l.jsx)(n.h3,{id:"5-utiliser-le-multi-tenancy",children:"5. Utiliser le multi-tenancy"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:"# Configuration Loki pour multi-tenancy\nauth_enabled: true\n\n# Promtail avec tenant_id\nclients:\n  - url: http://loki:3100/loki/api/v1/push\n    tenant_id: team-a\n"})}),"\n",(0,l.jsx)(n.h2,{id:"cas-dusage-avanc\xe9s-",children:"Cas d'usage avanc\xe9s \ud83d\ude80"}),"\n",(0,l.jsx)(n.h3,{id:"alerting-avec-loki-et-prometheus",children:"Alerting avec Loki et Prometheus"}),"\n",(0,l.jsx)(n.p,{children:"La cr\xe9ation d'alertes bas\xe9es sur les logs est possible via le ruler Loki ou en exposant des m\xe9triques \xe0 Prometheus :"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:'# Recording rules dans Loki\ngroups:\n  - name: logs\n    interval: 1m\n    rules:\n      - record: log_error_rate\n        expr: |\n          sum by (app) (rate({job="myapp"} |= "error" [5m]))\n'})}),"\n",(0,l.jsx)(n.h3,{id:"tracer-les-requ\xeates-entre-services",children:"Tracer les requ\xeates entre services"}),"\n",(0,l.jsx)(n.p,{children:"Utiliser le trace ID dans les logs pour corr\xe9ler les logs entre microservices :"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-logql",children:'# Rechercher tous les logs d\'une trace\n{job="myapp"} | json | trace_id="abc123"\n'})}),"\n",(0,l.jsx)(n.h3,{id:"d\xe9tecter-les-anomalies",children:"D\xe9tecter les anomalies"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-logql",children:'# Comparer le taux actuel au taux habituel\n(\n  sum(rate({job="myapp"}[5m]))\n  /\n  avg_over_time(sum(rate({job="myapp"}[5m]))[1h:5m])\n) > 2\n'})}),"\n",(0,l.jsx)(n.h2,{id:"conclusion-",children:"Conclusion \ud83c\udfaf"}),"\n",(0,l.jsx)(n.p,{children:"Loki r\xe9volutionne la gestion des logs en adoptant une approche minimaliste et efficace. Son int\xe9gration native avec Grafana et sa compatibilit\xe9 avec l'\xe9cosyst\xe8me Prometheus en font un choix excellent pour les infrastructures cloud-native."}),"\n",(0,l.jsx)(n.p,{children:"Les points cl\xe9s \xe0 retenir :"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"\xc9conomique"})," : pas d'indexation du contenu, stockage objet"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Performant"})," : indexation des labels seulement"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Simple"})," : architecture inspir\xe9e de Prometheus"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Puissant"})," : LogQL pour requ\xeater et agr\xe9ger les logs"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Cloud-native"})," : parfait pour Kubernetes"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Les prochains articles aborderont la combinaison de Loki avec Prometheus et Grafana pour une stack d'observabilit\xe9 compl\xe8te."}),"\n",(0,l.jsx)(n.h2,{id:"ressources-utiles-",children:"Ressources utiles \ud83d\udcda"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://grafana.com/docs/loki/",children:"Documentation officielle Loki"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://grafana.com/docs/loki/latest/logql/",children:"LogQL Cheat Sheet"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://grafana.com/docs/loki/latest/best-practices/",children:"Best practices Loki"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://grafana.com/docs/loki/latest/clients/promtail/",children:"Promtail configuration"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(d,{...e})}):d(e)}},28453(e,n,s){s.d(n,{R:()=>o,x:()=>a});var r=s(96540);const l={},i=r.createContext(l);function o(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:o(e.components),r.createElement(i.Provider,{value:n},e.children)}},91362(e){e.exports=JSON.parse('{"permalink":"/pr-preview/pr-20/blog/2025/11/21/07-monitoring/loki-logs-management","source":"@site/blog/07-monitoring/2025-11-21-loki-logs-management.md","title":"Loki","description":"Loki, le syst\xe8me de gestion de logs inspir\xe9 de Prometheus, con\xe7u pour \xeatre simple, efficace et \xe9conomique.","date":"2025-11-21T00:00:00.000Z","tags":[{"inline":false,"label":"Observabilit\xe9","permalink":"/pr-preview/pr-20/blog/tags/monitoring"},{"inline":false,"label":"DevOps","permalink":"/pr-preview/pr-20/blog/tags/devops"}],"readingTime":8.22,"hasTruncateMarker":true,"authors":[],"frontMatter":{"title":"Loki","description":"Loki, le syst\xe8me de gestion de logs inspir\xe9 de Prometheus, con\xe7u pour \xeatre simple, efficace et \xe9conomique.","tags":["monitoring","devops"]},"unlisted":false,"prevItem":{"title":"Kubernetes : kubectl","permalink":"/pr-preview/pr-20/blog/2025/11/21/06-orchestration/kubectl-commandes-essentielles"},"nextItem":{"title":"Prometheus","permalink":"/pr-preview/pr-20/blog/2025/11/21/07-monitoring/prometheus-introduction"}}')}}]);