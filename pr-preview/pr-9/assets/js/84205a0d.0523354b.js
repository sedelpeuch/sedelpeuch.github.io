"use strict";(self.webpackChunksedelpeuch_net=self.webpackChunksedelpeuch_net||[]).push([[71],{18278:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>t,default:()=>u,frontMatter:()=>r,metadata:()=>l,toc:()=>c});var i=s(74848),o=s(28453);const r={title:"Dokku",description:"Dokku est une plateforme open-source permettant le d\xe9ploiement, la gestion et la mise \xe0 l'\xe9chelle des applications sur un serveur.",tags:["Devops","Orchestration","Alternatives"]},t=void 0,l={permalink:"/pr-preview/pr-9/blog/2024/03/10/06-orchestration/orchestration-dokku",source:"@site/blog/06-orchestration/2024-03-10-orchestration-dokku.md",title:"Dokku",description:"Dokku est une plateforme open-source permettant le d\xe9ploiement, la gestion et la mise \xe0 l'\xe9chelle des applications sur un serveur.",date:"2024-03-10T00:00:00.000Z",tags:[{inline:!0,label:"Devops",permalink:"/pr-preview/pr-9/blog/tags/devops"},{inline:!0,label:"Orchestration",permalink:"/pr-preview/pr-9/blog/tags/orchestration"},{inline:!0,label:"Alternatives",permalink:"/pr-preview/pr-9/blog/tags/alternatives"}],readingTime:3.9,hasTruncateMarker:!0,authors:[],frontMatter:{title:"Dokku",description:"Dokku est une plateforme open-source permettant le d\xe9ploiement, la gestion et la mise \xe0 l'\xe9chelle des applications sur un serveur.",tags:["Devops","Orchestration","Alternatives"]},unlisted:!1,prevItem:{title:"Docker pratiques de production",permalink:"/pr-preview/pr-9/blog/2024/03/17/03-containerization/docker-best-practices"},nextItem:{title:"Architecture compl\xe8te",permalink:"/pr-preview/pr-9/blog/2024/03/03/04-ci-cd/exemple"}},a={authorsImageUrls:[]},c=[{value:"Installation",id:"installation",level:2},{value:"Premi\xe8re application",id:"premi\xe8re-application",level:2},{value:"Construire sa propre application",id:"construire-sa-propre-application",level:2},{value:"Automatiser le d\xe9ploiement via Github Actions",id:"automatiser-le-d\xe9ploiement-via-github-actions",level:2},{value:"Astuces",id:"astuces",level:2}];function d(e){const n={a:"a",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.p,{children:["Une alternative PAAS open source \xe0 Heroku ",(0,i.jsx)(n.a,{href:"https://dokku.com/",children:"https://dokku.com/"}),"\nDokku est une plateforme open-source permettant le d\xe9ploiement, la gestion et la mise \xe0 l'\xe9chelle des applications sur un serveur. Inspir\xe9 par Heroku, il utilise une approche similaire pour le d\xe9ploiement d'applications : le code se d\xe9ploie en effectuant un \"push\" vers un d\xe9p\xf4t Git sur le serveur. \xc0 la diff\xe9rence de Heroku, Dokku offre un contr\xf4le total sur l'environnement de d\xe9ploiement. Ainsi, l'infrastructure, le syst\xe8me d'exploitation et les services (tels que les bases de donn\xe9es ou les files d'attente de t\xe2ches) peuvent \xeatre personnalis\xe9s selon les besoins. Dokku s'appuie sur Docker pour g\xe9rer les applications dans des conteneurs isol\xe9s, ce qui simplifie la gestion des applications et de leurs d\xe9pendances. Chaque \"push\" d'une application \xe0 Dokku cr\xe9e un nouveau conteneur Docker."]}),"\n",(0,i.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:'# download the installation script\nwget -NP . <https://dokku.com/bootstrap.sh>\n# run the installer\nsudo DOKKU_TAG=v0.32.3 bash bootstrap.sh\n# and your ssh key to the dokku user\nPUBLIC_KEY="your-public-key-contents-here"\necho "$PUBLIC_KEY" | dokku ssh-keys:add admin\n'})}),"\n",(0,i.jsx)(n.h2,{id:"premi\xe8re-application",children:"Premi\xe8re application"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"# define global domains\ndokku domains:set-global <your-domain>\n# <your-domain> can be a rd party domain or a local domain like sonu-dev-gzsim.local\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Sur la machine o\xf9 ",(0,i.jsx)(n.code,{children:"dokku"})," est install\xe9"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"dokku apps:create <app-name>\nsudo dokku plugin:install <https://github.com/dokku/dokku-postgres.git>\ndokku postgres:create railsdatabase\ndokku postgres:link railsdatabase <app-name>\n"})}),"\n",(0,i.jsx)(n.p,{children:"Sur la machine locale"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"cd <app-name>\ngit remote add dokku dokku@<your-domain>:<app-name>\ngit push dokku main\n"})}),"\n",(0,i.jsx)(n.h2,{id:"construire-sa-propre-application",children:"Construire sa propre application"}),"\n",(0,i.jsx)(n.p,{children:"Dokku supporte plusieurs m\xe9thodes de build pour cr\xe9er des applications, chacun avec ses propres avantages sp\xe9cifiques :"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://dokku.com/docs/deployment/builders/dockerfiles/",children:(0,i.jsx)(n.strong,{children:"builder-dockerfile"})}),": Cette m\xe9thode utilise un Dockerfile pour construire des applications via la commande ",(0,i.jsx)(n.code,{children:"docker build"}),". Il donne un contr\xf4le maximal sur l'environnement d'ex\xe9cution de l'application et sur la mani\xe8re dont l'application est assembl\xe9e."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://dokku.com/docs/deployment/builders/herokuish-buildpacks/",children:(0,i.jsx)(n.strong,{children:"builder-herokuish"})}),": Avec cette m\xe9thode, Dokku cr\xe9e des applications en utilisant la sp\xe9cification v2a Buildpack de Heroku via ",(0,i.jsx)(n.code,{children:"gliderlabs/herokuish"}),". Il vous permet de profiter du m\xeame pipeline de build que Heroku, qui inclut le support pour de nombreux langages de programmation par d\xe9faut."]}),"\n",(0,i.jsx)(n.li,{children:"builder-lambda: Ce g\xe9n\xe9rateur construit des fonctions AWS Lambda dans un environnement simulant les temps d'ex\xe9cution d'AWS Lambda."}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"builder-null"}),": Cette m\xe9thode ne fait rien pendant la phase de construction. C'est utile pour les sc\xe9narios o\xf9 aucune construction n'est n\xe9cessaire, comme le d\xe9ploiement d'applications d\xe9j\xe0 compil\xe9es ou de conteneurs Docker."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"builder-pack"}),": Cette m\xe9thode utilise les Cloud Native Buildpacks pour construire des applications via l'outil pack-cli. Les Cloud Native Buildpacks sont une norme ouverte qui \xe9tend les capacit\xe9s des Buildpacks classiques."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"automatiser-le-d\xe9ploiement-via-github-actions",children:"Automatiser le d\xe9ploiement via Github Actions"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"name: Deploy to Dokku (sonu-dev-gzsim)\non:\n    schedule:\n    - cron: '0 0 * * *'\n    workflow_dispatch:\n    workflow_run:\n    workflows: [ \"Test build\" ]\n    types:\n        - completed\njobs:\n    deploy:\n    runs-on:\n        group: default\n    steps:\n        - name: Cloning repo\n        uses: actions/checkout@v4\n        with:\n            fetch-depth: 0\n\n        - name: Tailscale\n        uses: tailscale/github-action@v2\n        with:\n            oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}\n            oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}\n            tags: tag:server\n\n        - name: Push to dokku\n        uses: dokku/github-action@master\n        with:\n            git_remote_url: 'ssh://dokku@100.65.237.90:22/rd25-robotics'\n            ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}\n            branch: main\n            git_push_flags: '--force'\n\n    if: ${{ github.event.workflow_run.conclusion == 'success' }}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"astuces",children:"Astuces"}),"\n",(0,i.jsxs)(n.p,{children:["\u26a0\ufe0f Les astuces ci dessous correspondent ",(0,i.jsx)(n.strong,{children:"tr\xe8s certainement"})," \xe0 une incompr\xe9hension des m\xe9canismes de domain, proxy et reverse proxy"]}),"\n",(0,i.jsxs)(n.p,{children:["Par d\xe9faut ",(0,i.jsx)(n.code,{children:"dokku"})," d\xe9ploie l\u2019application sur une url construite comme suit : ",(0,i.jsx)(n.code,{children:"http://<app-name>.<your-domain>"})," visiblement si le domaine est local (comme ",(0,i.jsx)(n.code,{children:"sonu-dev-gzsim.local"}),") le reverse proxy ne fonctionne pas (la configuration ",(0,i.jsx)(n.code,{children:"nginx"})," est \xe0 creuser) il est donc n\xe9cessaire de ",(0,i.jsx)(n.code,{children:"disable"})," les domains avec la commande"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"dokku domains:disable <app-name>\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Cela aura pour effet de d\xe9sactiver le domaine pour l\u2019application en question. Elle tournera donc directement sur le port d\xe9fini al\xe9atoirement par ",(0,i.jsx)(n.code,{children:"dokku"}),".\n\xc0 chaque d\xe9ploiement, ",(0,i.jsx)(n.code,{children:"dokku"})," construit un ",(0,i.jsx)(n.code,{children:"dokker"})," pour g\xe9rer les applications de mani\xe8re isol\xe9e. Par d\xe9faut, les applications de type web doivent fournir leurs services sur le port ",(0,i.jsx)(n.code,{children:"5000"}),". Par la suite, ",(0,i.jsx)(n.code,{children:"dokku"})," s\u2019occupe de faire la redirection de port entre la machine et le container. Pour \xe9viter d\u2019avoir un port al\xe9atoire, il est possible de faire"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"dokku ports:set <app-name> http:<machine-port>:<docker-port>\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Ainsi, \xe0 chaque d\xe9ploiement, ",(0,i.jsx)(n.code,{children:"dokku"})," redirigera le port de la machine vers le port du docker.\nFinalement si vous souhaitez mettre en place une redirection comme ",(0,i.jsx)(n.code,{children:"http://<your-domain>/<app-name>"})," vers l\u2019application il suffit de faire les modifications suivantes dans ",(0,i.jsx)(n.code,{children:"nginx"}),"\nModifiez le fichier de configuration de Nginx pour votre site :"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"sudo nano /etc/nginx/sites-available/your-config-file\n"})}),"\n",(0,i.jsx)(n.p,{children:"Ajoutez la directive location dans votre configuration :"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-txt",children:"server { listen 80; server_name <your-domain>; location = <app-name> { return 301 http://$host:<machine-port>; } }\n"})}),"\n",(0,i.jsx)(n.p,{children:"Cr\xe9ez un lien symbolique vers le fichier de configuration :"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"sudo ln -s /etc/nginx/sites-available/your-config-file /etc/nginx/sites-enabled/\n"})}),"\n",(0,i.jsx)(n.p,{children:"V\xe9rifiez la configuration de Nginx :"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"sudo nginx -t\n"})}),"\n",(0,i.jsx)(n.p,{children:"Red\xe9marrez Nginx pour appliquer les modifications :"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"sudo systemctl restart nginx\n"})})]})}function u(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>t,x:()=>l});var i=s(96540);const o={},r=i.createContext(o);function t(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:t(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);